<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Event</title>
  <style>
    :root {
      --page-bg: #f5f5f5; /* default */
    }

    html, body {
      height: 100%;
    }

    html {
      background: var(--page-bg);  /* theme color */
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 0;
      background: transparent;     /* was #f5f5f5; make it transparent */
    }

    header {
      background: #333;
      color: white;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header .left {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    header .right {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    header a {
      color: #ffd700;
      text-decoration: none;
      font-weight: 500;
    }

    main {
      padding: 1rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    .panel {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    }

    .panel h2 {
      margin-top: 0;
    }

    .field-row {
      margin-bottom: 0.75rem;
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.95rem;
      gap: 0.25rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      max-width: 300px;
    }

    .checkbox-row {
      margin-bottom: 0.5rem;
    }

    .checkbox-row label {
      flex-direction: row;
      align-items: center;
      gap: 0.4rem;
    }

    button {
      padding: 0.45rem 0.9rem;
      border-radius: 4px;
      border: none;
      background: #333;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
    }

    button.secondary {
      background: #555;
      font-size: 0.85rem;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: #eee;
      font-size: 0.85rem;
    }

    .pill button {
      background: transparent;
      border: none;
      color: #333;
      font-size: 0.8rem;
      padding: 0;
      margin: 0;
      cursor: pointer;
    }

    .inline-input {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.25rem;
      align-items: center;
    }

    .inline-input input[type="number"] {
      width: 90px;
    }

    .error {
      color: #b00020;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .success {
      color: #0a7f3f;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    #row-notifications {
      margin-top: 0.75rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <a href="/events">Create Event</a>
      <a href="/events/all">All Events</a>
    </div>
    <div class="right">
      <button type="button" id="btn-settings" class="btn-link">Settings</button>
    </div>
  </header>

  <main>
    <h1>Edit Event</h1>
    <p style="margin: 0 0 0.75rem 0; color:#4b5563; max-width: 720px;">
      Update the base event and its milestones. Saving will recreate milestones using the new settings.
    </p>

    <div class="panel">
      <h2>Edit Event</h2>
      <form id="edit-event-form">
        <div class="field-row">
          <label>Type
            <select id="eventtype">
              <option value="birthday">Birthday üéÇ</option>
              <option value="wedding">Wedding üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®üèª</option>
              <option value="engagement">Engagement üíç</option>
              <option value="other_individual">üë§ Other - Individual</option>
              <option value="other_couple">üë• Other - Couple</option>
            </select>
          </label>
        </div>

        <div class="field-row" id="row-title" style="display:none;">
          <label>Title
            <input type="text" id="title">
          </label>
        </div>

        <div class="field-row">
          <label><span id="label-name1-text">Name</span>
            <input type="text" id="name1" required>
          </label>
        </div>

        <div class="field-row" id="row-couple-name2">
          <label>Name 2
            <input type="text" id="name2">
          </label>
        </div>

        <div class="field-row">
          <label>
            <span>Base date üìÖ</span>
            <input type="date" id="basedate" required>
          </label>
        </div>

        <div class="field-row">
          <label>
            <span>Timezone üåç</span>
            <select id="timezone">
              {% for tz in TIMEZONES %}
                <option value="{{ tz }}">{{ tz }}</option>
              {% endfor %}
            </select>
          </label>
        </div>

        <div class="field-row">
          <label>
            <span>Event time ‚è∞ (HH:MM)</span>
            <input type="text" id="sendtime" required>
          </label>
        </div>

        <div class="checkbox-row" id="row-create-calendar">
          <label>
            <input type="checkbox" id="createcalendar">
            <span>Create Calendar Event</span>
          </label>
        </div>

        <div class="checkbox-row" id="row-milestones">
          <label>
            <input type="checkbox" id="createmilestones">
            <span>Create milestone events</span>
          </label>
        </div>

        <div id="milestones-config" style="display:none; margin-top:0.5rem;">
          <label>Milestone days from base date</label>
          <div class="pill-list" id="milestone-pills"></div>
          <div class="inline-input">
            <input type="number" id="milestone-input" placeholder="e.g. 120">
            <button type="button" id="btn-add-milestone" class="secondary">Add</button>
          </div>
          <small>Only milestones after today will be created.</small>
        </div>

        <div class="checkbox-row" id="row-notifications">
          <label>
            <input type="checkbox" id="createnotifications">
            <span>Add notifications to calendar event</span>
          </label>
        </div>

        <div id="notifications-section" style="display:none;">
          <div class="field-row">
            <label>Notifications for this event
              <div class="inline-input">
                <input type="number" id="event-notify-number" min="0" placeholder="e.g. 7">
                <select id="event-notify-unit">
                  <option value="minutes">Minutes</option>
                  <option value="hours">Hours</option>
                  <option value="days">Days</option>
                  <option value="weeks">Weeks</option>
                  <option value="months">Months</option>
                </select>
                <button type="button" id="event-notify-add" class="secondary">Add</button>
              </div>
              <div class="settings-tag-list" id="event-notify-tags"></div>
              <div class="settings-small">Maximum 5 notifications per event.</div>
            </label>
          </div>
        </div>

        <button type="submit">Save Changes</button>
        <button type="button" id="btn-cancel" class="secondary" style="margin-left:0.5rem;">Cancel</button>
      </form>
      <div id="edit-status" class="error"></div>
      <div id="edit-ok" class="success"></div>
    </div>
  </main>

  <script>
    const accessToken = localStorage.getItem("access_token") || "";
    const eventId = {{ event_id|int }};
    let googleConnected = false;

    // settings defaults
    const DEFAULT_MILESTONE_DAYS = [100, 500, 1000, 2500, 5000, 10000, 15000, 20000, 25000, 30000];
    let defaultMilestoneDays = DEFAULT_MILESTONE_DAYS.slice();
    let settingsMilestoneDays = defaultMilestoneDays.slice();
    let defaultNotifications = [
      { value: 1, unit: "hours" },
      { value: 2, unit: "hours" },
      { value: 1, unit: "days" },
      { value: 1, unit: "weeks" },
      { value: 2, unit: "weeks" }
    ]; // list of { value, unit }

    let milestoneDays = defaultMilestoneDays.slice();

    async function apiRequest(path, options = {}) {
      const headers = options.headers || {};
      if (!headers["Content-Type"]) {
        headers["Content-Type"] = "application/json";
      }
      if (accessToken) {
        headers["Authorization"] = "Bearer " + accessToken;
      }
      const res = await fetch(path, { ...options, headers });
      const text = await res.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (e) {
        data = text;
      }
      if (!res.ok) {
        const detail = data && data.detail ? data.detail : res.statusText;
        throw new Error(detail);
      }
      return data;
    }

    async function fetchIntegrationsStatus() {
      if (!accessToken) {
        googleConnected = false;
        return;
      }
      try {
        const data = await apiRequest("/api/integrations/status");
        googleConnected = !!data.google_connected;
      } catch (e) {
        googleConnected = false;
      }
    }

    let eventNotifications = defaultNotifications.slice(); // start from Settings list
    let eventNotifyTags = null;
    let createNotificationsEl = null;

    function renderEventNotifyTags() {
      eventNotifyTags.innerHTML = "";

      const unitToMinutes = {
        minutes: 1,
        hours: 60,
        days: 60 * 24,
        weeks: 60 * 24 * 7,
        months: 60 * 24 * 30
      };

      const sorted = eventNotifications
        .map((n, index) => ({
          ...n,
          index,
          minutes: n.value * (unitToMinutes[n.unit] || 1)
        }))
        .sort((a, b) => a.minutes - b.minutes);

      sorted.forEach((nWrapped) => {
        const n = nWrapped;
        const pill = document.createElement("span");
        pill.className = "pill";

        const labelUnit =
          n.value === 1 && n.unit.endsWith("s")
            ? n.unit.slice(0, -1)
            : n.unit;

        pill.textContent = `${n.value} ${labelUnit}`;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "√ó";
        btn.addEventListener("click", () => {
          eventNotifications = eventNotifications.filter((_, i) => i !== n.index);
          renderEventNotifyTags();
        });

        pill.appendChild(btn);
        eventNotifyTags.appendChild(pill);
      });
    }

    function setupEditForm() {
      const form = document.getElementById("edit-event-form");
      const eventTypeEl = document.getElementById("eventtype");
      const titleRow = document.getElementById("row-title");
      const titleInput = document.getElementById("title");
      const labelName1Text = document.getElementById("label-name1-text");
      const rowCoupleName2 = document.getElementById("row-couple-name2");
      const name2Input = document.getElementById("name2");
      const baseDateInput = document.getElementById("basedate");
      const timezoneInput = document.getElementById("timezone");
      const sendTimeInput = document.getElementById("sendtime");
      const createCalendarEl = document.getElementById("createcalendar");
      const createMilestonesEl = document.getElementById("createmilestones");
      const milestonesConfig = document.getElementById("milestones-config");
      const milestoneInput = document.getElementById("milestone-input");
      const milestonePills = document.getElementById("milestone-pills");
      const btnAddMilestone = document.getElementById("btn-add-milestone");
      const eventNotifyNumber = document.getElementById("event-notify-number");
      const eventNotifyUnit = document.getElementById("event-notify-unit");
      const eventNotifyAdd = document.getElementById("event-notify-add");
      eventNotifyTags = document.getElementById("event-notify-tags");
      const editStatus = document.getElementById("edit-status");
      const editOk = document.getElementById("edit-ok");
      const btnCancel = document.getElementById("btn-cancel");

      createNotificationsEl = document.getElementById("createnotifications");

      if (createNotificationsEl) {
        createNotificationsEl.checked = googleConnected;
      }

      const notificationsSection = document.getElementById("notifications-section");

      if (createNotificationsEl) {
        // Initial visibility
        notificationsSection.style.display = createNotificationsEl.checked ? "" : "none";

        createNotificationsEl.addEventListener("change", () => {
          if (createNotificationsEl.checked && !googleConnected) {
            createNotificationsEl.checked = false;
            notificationsSection.style.display = "none";
            alert("Google Calendar is not connected. Please connect Google Calendar first.");
            return;
          }
          // Toggle section when checkbox changes
          notificationsSection.style.display = createNotificationsEl.checked ? "" : "none";
        });
      }

      function renderMilestones() {
        milestonePills.innerHTML = "";
        milestoneDays.forEach((d) => {
          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = d + " days";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "√ó";
          btn.addEventListener("click", () => {
            milestoneDays = milestoneDays.filter((x) => x !== d);
            renderMilestones();
          });
          pill.appendChild(btn);
          milestonePills.appendChild(pill);
        });
      }

      milestoneInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const val = parseInt(milestoneInput.value, 10);
          if (!isNaN(val) && val > 0 && !milestoneDays.includes(val)) {
            milestoneDays.push(val);
            milestoneDays.sort((a, b) => a - b);
            renderMilestones();
            milestoneInput.value = "";
          }
        }
      });

      btnAddMilestone.addEventListener("click", () => {
        const val = parseInt(milestoneInput.value, 10);
        if (!isNaN(val) && val > 0 && !milestoneDays.includes(val)) {
          milestoneDays.push(val);
          milestoneDays.sort((a, b) => a - b);
          renderMilestones();
          milestoneInput.value = "";
        }
      });

      function updateTypeDependentFields() {
        const type = eventTypeEl.value;

        if (type === "other_individual" || type === "other_couple") {
          titleRow.style.display = "";
        } else {
          titleRow.style.display = "none";
          titleInput.value = "";
        }

        if (type === "wedding" || type === "engagement" || type === "other_couple") {
          labelName1Text.textContent = "Name 1";
          rowCoupleName2.style.display = "";
        } else {
          labelName1Text.textContent = "Name";
          rowCoupleName2.style.display = "none";
          name2Input.value = "";
        }
      }

      eventTypeEl.addEventListener("change", updateTypeDependentFields);

      createCalendarEl.addEventListener("change", () => {
        if (createCalendarEl.checked && !googleConnected) {
          createCalendarEl.checked = false;
          alert("Google Calendar is not connected. Please connect Google Calendar first.");
        }
      });

      createMilestonesEl.addEventListener("change", () => {
        milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";
      });

      btnCancel.addEventListener("click", () => {
        // Prefer real browser back if there is history
        if (window.history.length > 1) {
          window.history.back();
          return;
        }

        // Fallback: use referrer if it looks like one of your app pages
        if (document.referrer && document.referrer.indexOf(window.location.origin) === 0) {
          window.location.href = document.referrer;
          return;
        }

        // Final fallback: All Events
        window.location.href = "/events/all";
      });


      if (eventNotifyAdd && eventNotifyNumber && eventNotifyUnit) {
        eventNotifyAdd.addEventListener("click", () => {
          const val = parseInt(eventNotifyNumber.value, 10);
          const unit = eventNotifyUnit.value;
          if (!isNaN(val) && val >= 0) {
            if (eventNotifications.length >= 5) {
              alert("You can only have up to 5 notifications per event.");
              return;
            }
            const exists = eventNotifications.some((n) => n.value === val && n.unit === unit);
            if (!exists) {
              eventNotifications.push({ value: val, unit });
              renderEventNotifyTags();
            }
            eventNotifyNumber.value = "";
            eventNotifyUnit.value = "days";
          }
        });

        eventNotifyNumber.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const val = parseInt(eventNotifyNumber.value, 10);
            const unit = eventNotifyUnit.value;
            if (!isNaN(val) && val >= 0) {
              if (eventNotifications.length >= 5) {
                alert("You can only have up to 5 notifications per event.");
                return;
              }
              const exists = eventNotifications.some((n) => n.value === val && n.unit === unit);
              if (!exists) {
                eventNotifications.push({ value: val, unit });
                renderEventNotifyTags();
              }
              eventNotifyNumber.value = "";
              eventNotifyUnit.value = "days";
            }
          }
        });
      }


      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        editStatus.textContent = "";
        editOk.textContent = "";

        if (!accessToken) {
          editStatus.textContent = "You must be logged in.";
          return;
        }

        const use_notifications = createNotificationsEl ? createNotificationsEl.checked : false;

        const payload = {
          event_type: eventTypeEl.value,
          name1: document.getElementById("name1").value.trim(),
          name2: name2Input.value.trim() || null,
          base_date: baseDateInput.value,
          timezone: timezoneInput.value,
          send_time: sendTimeInput.value.trim(),
          create_calendar: createCalendarEl.checked,
          create_milestones: createMilestonesEl.checked,
          milestone_days: milestoneDays,
          title: titleInput.value.trim() || null,
          notifications: use_notifications ? eventNotifications : [],
        };

        try {
          const data = await apiRequest(`/api/events/${eventId}`, {
            method: "PUT",
            body: JSON.stringify(payload),
          });
          editOk.textContent = "Event updated.";
          setTimeout(() => {
            window.location.href = `/events/${data.id}`;
          }, 800);
        } catch (err) {
          editStatus.textContent = err.message || "Error updating event.";
        }
      });

      milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";
      renderMilestones();
      updateTypeDependentFields();
    }

    async function loadEvent() {
      const editStatus = document.getElementById("edit-status");
      if (!accessToken) {
        editStatus.textContent = "You must be logged in.";
        return;
      }
      try {
        const evt = await apiRequest(`/api/events/${eventId}`);
        if (Array.isArray(evt.notifications) && evt.notifications.length > 0) {
          eventNotifications = evt.notifications.slice();
          if (createNotificationsEl) createNotificationsEl.checked = true;
        } else {
          eventNotifications = defaultNotifications.slice();
          if (createNotificationsEl && !googleConnected) {
            createNotificationsEl.checked = false;
          }
        }
        renderEventNotifyTags();
        const notificationsSection = document.getElementById("notifications-section");
        if (notificationsSection && createNotificationsEl) {
          notificationsSection.style.display = createNotificationsEl.checked ? "" : "none";
        }
        document.getElementById("eventtype").value = evt.event_type;
        document.getElementById("name1").value = evt.name1 || "";
        document.getElementById("name2").value = evt.name2 || "";
        document.getElementById("basedate").value = evt.base_date;
        document.getElementById("timezone").value = evt.timezone;
        document.getElementById("sendtime").value = evt.send_time;
        document.getElementById("createcalendar").checked = !!evt.create_calendar;
        document.getElementById("createmilestones").checked = !!evt.create_milestones;
        if (evt.title) {
          document.getElementById("title").value = evt.title;
        }
        if (Array.isArray(evt.milestone_days) && evt.milestone_days.length > 0) {
          milestoneDays = evt.milestone_days.slice().sort((a, b) => a - b);
        }
        const createMilestonesEl = document.getElementById("createmilestones");
        const milestonesConfig = document.getElementById("milestones-config");
        milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";

        const milestonePills = document.getElementById("milestone-pills");
        milestonePills.innerHTML = "";
        milestoneDays.forEach((d) => {
          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = d + " days";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "√ó";
          btn.addEventListener("click", () => {
            milestoneDays = milestoneDays.filter((x) => x !== d);
            pill.remove();
          });
          pill.appendChild(btn);
          milestonePills.appendChild(pill);
        });
      } catch (err) {
        editStatus.textContent = err.message || "Error loading event.";
      }
    }

    async function loadTheme() {
      if (!accessToken) {
        document.documentElement.style.setProperty("--page-bg", "#f5f5f5");
        return;
      }
      try {
        const me = await apiRequest("/api/me");
        const theme = me.theme_color || "#f5f5f5";
        document.documentElement.style.setProperty("--page-bg", theme);
      } catch (e) {
        document.documentElement.style.setProperty("--page-bg", "#f5f5f5");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadTheme();
      await fetchIntegrationsStatus();
      setupEditForm();
      await loadEvent();
    });
  </script>
</body>
</html>
