<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Events - Milestone Events</title>
  <style>
    :root {
      --page-bg: #f5f5f5; /* default */
    }

    html, body {
      height: 100%;
    }

    html {
      background: var(--page-bg);  /* theme color */
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 0;
      background: transparent;     /* was #f5f5f5; make it transparent */
    }

    header {
      background: #333;
      color: white;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header .left {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    header .right {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    header a {
      color: #ffd700;
      text-decoration: none;
      font-weight: 500;
    }

    main {
      padding: 1rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    h2 {
      margin: 0 0 0.5rem 0;
    }

    .panel {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }

    button {
      padding: 0.35rem 0.7rem;
      border-radius: 4px;
      border: none;
      background: #333;
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn-delete {
      background: #b00020;
      margin-left: 0.25rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <a href="/events">Create Event</a>
    </div>
    <div class="right">
      <button type="button" id="btn-settings" class="btn-link">Settings</button>
    </div>
  </header>

  <main>
    <h1>All events</h1>
    <p style="margin: 0 0 0.75rem 0; color:#4b5563; max-width: 720px;">
      Browse all base events grouped by type. Deleting a base event also deletes its milestones.
    </p>

    <div class="panel">
      <h2>Birthdays</h2>
      <table id="all-birthday-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Name(s)</th>
            <th>Base Date</th>
            <th>Days Since</th>
            <th>Timezone</th>
            <th>Send Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h2>Weddings</h2>
      <table id="all-wedding-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Name(s)</th>
            <th>Base Date</th>
            <th>Days Since</th>
            <th>Timezone</th>
            <th>Send Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h2>Engagements</h2>
      <table id="all-engagement-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Name(s)</th>
            <th>Base Date</th>
            <th>Days Since</th>
            <th>Timezone</th>
            <th>Send Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h2>Other Individual</h2>
      <table id="all-other-individual-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Name(s)</th>
            <th>Base Date</th>
            <th>Days Since</th>
            <th>Timezone</th>
            <th>Send Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h2>Other Couple</h2>
      <table id="all-other-couple-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Name(s)</th>
            <th>Base Date</th>
            <th>Days Since</th>
            <th>Timezone</th>
            <th>Send Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    let accessToken = null;

    function ensureLoggedIn() {
      const token = localStorage.getItem("access_token");
      if (!token) {
        window.location.href = "/login";
        return;
      }
      accessToken = token;
    }

    async function apiRequest(path, options = {}) {
      const headers = options.headers || {};
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
      if (accessToken) {
        headers["Authorization"] = "Bearer " + accessToken;
      }
      const res = await fetch(path, { ...options, headers });
      const text = await res.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (e) {
        data = text;
      }
      if (!res.ok) {
        const detail = data && data.detail ? data.detail : res.statusText;
        throw new Error(detail);
      }
      return data;
    }

    async function loadAll() {
      try {
        const data = await apiRequest("/api/events");
        const buckets = {
          birthday: [],
          wedding: [],
          engagement: [],
          other_individual: [],
          other_couple: [],
        };
        data.forEach((evt) => {
          if (buckets[evt.event_type]) {
            buckets[evt.event_type].push(evt);
          }
        });

        function renderBucket(events, tableId) {
          const tbody = document.querySelector(`#${tableId} tbody`);
          tbody.innerHTML = "";
          events.forEach((evt, idx) => {
            const displayId = idx + 1;
            const tr = document.createElement("tr");
            const names = evt.name2 ? `${evt.name1} & ${evt.name2}` : evt.name1;

            // --- 1. Fix Timezone Drift ---
            // Force local time so Jan 6 remains Jan 6 in your local timezone
            const bDate = new Date(evt.base_date + "T00:00:00");
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            // --- 2. Accurate Math ---
            // Use Math.round to ensure 2026-01-10 minus 2026-01-06 equals exactly 4
            const diff = Math.round((now - bDate) / (1000 * 60 * 60 * 24));
            
            // --- 3. Highlight Text Only (No Row Background) ---
            let daysStyle = "";
            const mList = [100, 500, 1000, 2500, 5000, 10000, 15000, 20000, 25000, 30000];
            
            if (mList.includes(diff)) {
              // Exact milestone: Green text
              daysStyle = 'style="color: #0a7f3f; font-weight: bold;"';
            } else {
              for (let m of mList) {
                if (diff >= (m - 14) && diff < m) {
                  // Approaching milestone: Orange text
                  daysStyle = 'style="color: orange; font-weight: bold;"';
                  break;
                }
              }
            }

            tr.innerHTML = `
              <td>${displayId}</td>
              <td>${names}</td>
              <td>${evt.base_date}</td>
              <td ${daysStyle}>${diff}</td>
              <td>${evt.timezone}</td>
              <td>${evt.send_time}</td>
              <td>
                <button data-id="${evt.id}" class="btn-view">View</button>
                <button data-id="${evt.id}" class="btn-delete">Delete</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        renderBucket(buckets.birthday, "all-birthday-table");
        renderBucket(buckets.wedding, "all-wedding-table");
        renderBucket(buckets.engagement, "all-engagement-table");
        renderBucket(buckets.other_individual, "all-other-individual-table");
        renderBucket(buckets.other_couple, "all-other-couple-table");
      } catch (err) {
        console.error("Error loading all", err);
      }
    }

    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("btn-view")) {
        const id = e.target.getAttribute("data-id");
        window.location.href = `/events/${id}`;
      }
      if (e.target.classList.contains("btn-delete")) {
        const id = e.target.getAttribute("data-id");
        if (!confirm("Delete this event and its milestones?")) return;
        try {
          await apiRequest(`/api/events/${id}`, { method: "DELETE" });
          await loadAll();
        } catch (err) {
          alert(err.message || "Delete failed.");
        }
      }
    });

    async function loadTheme() {
      if (!accessToken) {
        document.documentElement.style.setProperty("--page-bg", "#f5f5f5");
        return;
      }
      try {
        const me = await apiRequest("/api/me");
        const theme = me.theme_color || "#f5f5f5";
        document.documentElement.style.setProperty("--page-bg", theme);
      } catch (e) {
        document.documentElement.style.setProperty("--page-bg", "#f5f5f5");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      ensureLoggedIn();
      await loadTheme();
      await loadAll();
    });
  </script>
</body>
</html>