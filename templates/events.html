<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Milestone Reminders</title>
  <style>
    :root {
      --page-bg: #f5f5f5; /* default */
    }

    html, body {
      height: 100%;
    }

    html {
      background: var(--page-bg);  /* theme color */
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 0;
      background: transparent;     /* was #f5f5f5; make it transparent */
    }

    header {
      background: #333;
      color: white;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header .left {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    header .right {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    header a {
      color: #ffd700;
      text-decoration: none;
      font-weight: 500;
    }

    main {
      padding: 1rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    .integrations-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .integration-block {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    .status-label {
      font-weight: 600;
    }

    .status-text {
      font-weight: 600;
    }

    .status-connected {
      color: #0a7f3f;
    }

    .status-disconnected {
      color: #b00020;
    }

    .btn-link {
      padding: 0.35rem 0.7rem;
      border-radius: 4px;
      border: none;
      background: #333;
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
    }

    .panel {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    }

    .panel h2 {
      margin-top: 0;
    }

    .field-row {
      margin-bottom: 0.75rem;
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.95rem;
      gap: 0.25rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      max-width: 300px;
    }

    .checkbox-row {
      margin-bottom: 0.5rem;
    }

    .checkbox-row label {
      flex-direction: row;
      align-items: center;
      gap: 0.4rem;
    }

    button {
      padding: 0.45rem 0.9rem;
      border-radius: 4px;
      border: none;
      background: #333;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
    }

    button.secondary {
      background: #555;
      font-size: 0.85rem;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: #eee;
      font-size: 0.85rem;
    }

    .pill button {
      background: transparent;
      border: none;
      color: #333;
      font-size: 0.8rem;
      padding: 0;
      margin: 0;
      cursor: pointer;
    }

    .inline-input {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.25rem;
      align-items: center;
    }

    .inline-input input[type="number"] {
      width: 90px;
    }

    .error {
      color: #b00020;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .success {
      color: #0a7f3f;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }

    .actions-cell a {
      margin-right: 0.4rem;
      text-decoration: none;
      color: #1a73e8;
    }

    .actions-cell button {
      background: #b00020;
      color: white;
      padding: 0.3rem 0.5rem;
      font-size: 0.85rem;
    }

    .settings-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .settings-bar label {
      flex-direction: row;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
    }

    .settings-bar input[type="color"] {
      padding: 0;
      border: none;
      width: 32px;
      height: 24px;
      background: transparent;
    }

    .theme-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .theme-modal {
      background: #ffffff;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
      max-width: 320px;
      width: 100%;
      font-size: 0.9rem;
    }

    .theme-modal h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
    }

    .theme-modal-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0 0.75rem 0;
    }

    .theme-modal-row input[type="color"] {
      padding: 0;
      border: none;
      width: 40px;
      height: 26px;
      background: transparent;
    }

    .theme-modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .theme-btn-text {
      background: transparent;
      border: none;
      color: #1f2937;
      padding: 0.35rem 0.7rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .theme-btn-primary {
      background: #333;
      color: #ffffff;
      border-radius: 4px;
      padding: 0.35rem 0.7rem;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }


  </style>
</head>
<body>
  <header>
    <div class="left">
      <a href="/events/all">All Events</a>
      <button type="button" id="btn-theme" class="btn-link">Theme</button>
    </div>
    <div class="right">
      <a href="/change-password">Change Password</a>
      <a href="/login">Logout</a>
    </div>
  </header>

  <main>
    <h1>Milestone reminders for people you care about</h1>
    <p style="margin: 0 0 0.75rem 0; color:#4b5563; max-width: 720px;">
      Use this page to store important dates for your friends and family so the app can automatically create reminders in your calendar and keep upcoming milestones in one place.
    </p>

    <div class="integrations-bar">
      <div class="integration-block">
        <span class="status-label">Google Calendar:</span>
        <span id="google-status-text" class="status-text status-disconnected"></span>
        <button type="button" class="btn-link" id="google-connect-btn">
          Connect Google Calendar
        </button>
      </div>
    </div>

    <div class="panel">
      <h2>Create Event</h2>
      <form id="create-event-form">
        <div class="field-row">
          <label>Type
            <select id="eventtype">
              <option value="birthday">Birthday üéÇ</option>
              <option value="wedding">Wedding üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®üèª</option>
              <option value="engagement">Engagement üíç</option>
              <option value="otherindividual">üë§ Other - Individual</option>
              <option value="othercouple">üë• Other - Couple</option>
            </select>
          </label>
        </div>

        <div class="field-row" id="row-title" style="display:none;">
          <label>Title
            <input type="text" id="title">
          </label>
        </div>

        <div class="field-row">
          <label><span id="label-name1-text">Name</span>
            <input type="text" id="name1" required>
          </label>
        </div>

        <div class="field-row" id="row-couple-name2">
          <label>Name 2
            <input type="text" id="name2">
          </label>
        </div>

        <div class="field-row">
          <label>
            <span>Base date üìÖ</span>
            <input type="date" id="basedate" required>
          </label>
        </div>

        <div class="field-row">
          <label>
            <span>Timezone üåç</span>
            <select id="timezone">
              {% for tz in TIMEZONES %}
                <option value="{{ tz }}">{{ tz }}</option>
              {% endfor %}
            </select>
          </label>
        </div>

        <div class="field-row">
          <label>
            <span>Event time ‚è∞ (HH:MM)</span>
            <input type="text" id="sendtime" required value="00:00">
          </label>
        </div>

        <div class="checkbox-row" id="row-create-calendar">
          <label>
            <input type="checkbox" id="createcalendar">
            <span>Create Calendar Event</span>
          </label>
        </div>

        <div class="checkbox-row" id="row-milestones">
          <label>
            <input type="checkbox" id="createmilestones" checked>
            <span>Create milestone events</span>
          </label>
        </div>

        <div id="milestones-config" style="display:none; margin-top:0.5rem;">
          <label>Milestone days from base date</label>
          <div class="pill-list" id="milestone-pills"></div>
          <div class="inline-input">
            <input type="number" id="milestone-input" placeholder="e.g. 120">
            <button type="button" id="btn-add-milestone" class="secondary">Add</button>
          </div>
          <small>Only milestones after today will be created.</small>
        </div>

        <button type="submit">Create</button>
      </form>
      <div id="create-status" class="error"></div>
      <div id="create-ok" class="success"></div>
    </div>

    <div class="panel">
      <h2>Upcoming Events (next 2 months)</h2>
      <button id="btn-refresh-upcoming">Refresh Upcoming</button>
      <table id="upcoming-table">
        <thead>
          <tr>
            <th>Name(s)</th>
            <th>Base Date</th>
            <th>Next Occurrence</th>
            <th>Timezone</th>
            <th>Send Time</th>
            <th>Days Since Base</th>
            <th>Days To Go</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="upcoming-body"></tbody>
      </table>
      <div id="upcoming-status" class="error"></div>
    </div>

    <div id="theme-modal-backdrop" class="theme-modal-backdrop">
      <div class="theme-modal">
        <h3>Theme background</h3>
        <div class="theme-modal-row">
          <input type="color" id="theme-color-picker">
          <span style="color:#4b5563;">Choose a color for the page background.</span>
        </div>
        <div class="theme-modal-buttons">
          <button type="button" id="btn-theme-reset" class="theme-btn-text">Reset to default</button>
          <button type="button" id="btn-theme-close" class="theme-btn-primary">Close</button>
        </div>
      </div>
    </div>

  </main>

  <script>
    
    const accessToken = localStorage.getItem("access_token") || "";
    const DEFAULT_THEME = "#f5f5f5";

    let googleConnected = false;

    async function fetchIntegrationsStatus() {
      const googleStatusText = document.getElementById("google-status-text");
      const createCalendarEl = document.getElementById("createcalendar");
      const googleConnectBtn = document.getElementById("google-connect-btn");

      if (!accessToken) {
        googleStatusText.textContent = "Not connected";
        googleStatusText.classList.remove("status-connected");
        googleStatusText.classList.add("status-disconnected");
        googleConnected = false;
        createCalendarEl.checked = false;
        googleConnectBtn.textContent = "Connect Google Calendar";
        return;
      }

      try {
        const resp = await fetch("/api/integrations/status", {
          headers: {
            Authorization: "Bearer " + accessToken,
          },
        });
        if (!resp.ok) throw new Error("status fetch failed");
        const data = await resp.json();

        googleConnected = !!data.google_connected;

        googleStatusText.textContent = googleConnected ? "Connected" : "Not connected";
        googleStatusText.classList.toggle("status-connected", googleConnected);
        googleStatusText.classList.toggle("status-disconnected", !googleConnected);

        createCalendarEl.checked = googleConnected;

        googleConnectBtn.textContent = googleConnected ? "Disconnect Google Calendar" : "Connect Google Calendar";
        googleConnectBtn.href = "/google_connect";
      } catch (e) {
        googleStatusText.textContent = "Error";
        googleStatusText.classList.remove("status-connected");
        googleStatusText.classList.add("status-disconnected");
        googleConnected = false;
        createCalendarEl.checked = false;
        googleConnectBtn.textContent = "Connect Google Calendar";
      }
    }

    function setupCreateForm() {
      const form = document.getElementById("create-event-form");
      const eventTypeEl = document.getElementById("eventtype");
      const titleRow = document.getElementById("row-title");
      const titleInput = document.getElementById("title");
      const labelName1Text = document.getElementById("label-name1-text");
      const rowCoupleName2 = document.getElementById("row-couple-name2");
      const createCalendarEl = document.getElementById("createcalendar");
      const createMilestonesEl = document.getElementById("createmilestones");
      const milestonesConfig = document.getElementById("milestones-config");
      const milestoneInput = document.getElementById("milestone-input");
      const milestonePills = document.getElementById("milestone-pills");
      const btnAddMilestone = document.getElementById("btn-add-milestone");
      const createStatus = document.getElementById("create-status");
      const createOk = document.getElementById("create-ok");

      let milestoneDays = [100, 500, 1000, 2500, 5000, 10000, 15000, 20000, 25000, 30000];

      function renderMilestones() {
        milestonePills.innerHTML = "";
        milestoneDays.forEach((d) => {
          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = d + " days";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "√ó";
          btn.addEventListener("click", () => {
            milestoneDays = milestoneDays.filter((x) => x !== d);
            renderMilestones();
          });
          pill.appendChild(btn);
          milestonePills.appendChild(pill);
        });
      }

      milestoneInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const val = parseInt(milestoneInput.value, 10);
          if (!isNaN(val) && val > 0 && !milestoneDays.includes(val)) {
            milestoneDays.push(val);
            milestoneDays.sort((a, b) => a - b);
            renderMilestones();
            milestoneInput.value = "";
          }
        }
      });

      btnAddMilestone.addEventListener("click", () => {
        const val = parseInt(milestoneInput.value, 10);
        if (!isNaN(val) && val > 0 && !milestoneDays.includes(val)) {
          milestoneDays.push(val);
          milestoneDays.sort((a, b) => a - b);
          renderMilestones();
          milestoneInput.value = "";
        }
      });

      function updateTypeDependentFields() {
        const type = eventTypeEl.value;

        if (type === "otherindividual" || type === "othercouple") {
          titleRow.style.display = "";
        } else {
          titleRow.style.display = "none";
          titleInput.value = "";
        }

        if (type === "wedding" || type === "engagement" || type === "othercouple") {
          labelName1Text.textContent = "Name 1";
          rowCoupleName2.style.display = "";
        } else {
          labelName1Text.textContent = "Name";
          rowCoupleName2.style.display = "none";
          document.getElementById("name2").value = "";
        }
      }

      eventTypeEl.addEventListener("change", updateTypeDependentFields);

      createCalendarEl.addEventListener("change", () => {
        if (createCalendarEl.checked && !googleConnected) {
          createCalendarEl.checked = false;
          alert("Google Calendar is not connected. Please connect Google Calendar first on the \"Connect Google Calendar\" page.");
        }
      });

      createMilestonesEl.addEventListener("change", () => {
        milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        createStatus.textContent = "";
        createOk.textContent = "";

        if (!accessToken) {
          createStatus.textContent = "You must be logged in.";
          return;
        }

        const event_type = eventTypeEl.value;
        const name1 = document.getElementById("name1").value.trim();
        const name2 = document.getElementById("name2").value.trim();
        const base_date = document.getElementById("basedate").value;
        const timezone = document.getElementById("timezone").value;
        const send_time = document.getElementById("sendtime").value.trim();
        const create_calendar = createCalendarEl.checked;
        const create_milestones = createMilestonesEl.checked;
        const title = titleInput.value.trim();

        const payload = {
          event_type,
          name1,
          name2: name2 || null,
          base_date,
          timezone,
          send_time,
          create_calendar,
          create_milestones,
          milestone_days: milestoneDays,
          title: title || null,
        };

        try {
          const resp = await fetch("/api/events", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + accessToken,
            },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          if (!resp.ok) {
            const msg = data.detail || "Error creating event.";
            createStatus.textContent = msg;
            alert(msg);
          } else {
            createOk.textContent = "Event created.";
            form.reset();
            milestoneDays = [100, 500, 1000, 2500, 5000, 10000, 15000, 20000, 25000, 30000];
            renderMilestones();
            document.getElementById("eventtype").value = "birthday";
            document.getElementById("createcalendar").checked = googleConnected;
            document.getElementById("createmilestones").checked = true;
            updateTypeDependentFields();
            milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";
            loadUpcomingEvents();
          }
        } catch (err) {
          createStatus.textContent = "Network error creating event.";
        }
      });

      milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";
      renderMilestones();
      updateTypeDependentFields();
    }

    async function loadUpcomingEvents() {
      const tbody = document.getElementById("upcoming-body");
      const statusEl = document.getElementById("upcoming-status");
      tbody.innerHTML = "";
      statusEl.textContent = "";

      if (!accessToken) {
        statusEl.textContent = "You must be logged in.";
        return;
      }

      try {
        const resp = await fetch("/api/events/upcoming", {
          headers: {
            Authorization: "Bearer " + accessToken,
          },
        });
        const data = await resp.json();
        if (!resp.ok) {
          statusEl.textContent = data.detail || "Error loading events.";
          return;
        }

        if (!Array.isArray(data) || data.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 8;
          td.textContent = "No upcoming events.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const sorted = data.slice().sort((a, b) => {
          const dA = a.next_occurrence || a.base_date;
          const dB = b.next_occurrence || b.base_date;
          if (dA < dB) return -1;
          if (dA > dB) return 1;
          const tA = a.send_time || "00:00";
          const tB = b.send_time || "00:00";
          return tA.localeCompare(tB);
        });

        sorted.forEach((evt) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = evt.name2 ? `${evt.name1} & ${evt.name2}` : evt.name1;

          // --- 1. Fix Base Date Column (Show Parent Date) ---
          const parentDateObj = new Date(evt.next_occurrence + "T00:00:00");
          parentDateObj.setDate(parentDateObj.getDate() - (evt.milestone_offset_days || 0));
          
          const bYear  = parentDateObj.getFullYear();
          const bMonth = String(parentDateObj.getMonth() + 1).padStart(2, "0");
          const bDay   = String(parentDateObj.getDate()).padStart(2, "0");
          
          const tdBase = document.createElement("td");
          tdBase.textContent = `${bYear}-${bMonth}-${bDay}`;

          const tdNext = document.createElement("td");
          tdNext.textContent = evt.next_occurrence;

          const tdTz = document.createElement("td");
          tdTz.textContent = evt.timezone;

          const tdTime = document.createElement("td");
          tdTime.textContent = evt.send_time;

          // --- 2. Days Since Base & Days To Go Calculation ---
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const nextDate = new Date(evt.next_occurrence + "T00:00:00");
          nextDate.setHours(0, 0, 0, 0);
          
          const daysToGo = Math.round((nextDate - today) / (1000 * 60 * 60 * 24));
          const tdDaysToGo = document.createElement("td");
          tdDaysToGo.textContent = daysToGo === 0 ? "Today" : daysToGo;

          const daysSince = Math.round((today - parentDateObj) / (1000 * 60 * 60 * 24));
          const tdDaysSince = document.createElement("td");
          tdDaysSince.textContent = daysSince;

          // --- 3. Milestone Text Coloring ---
          const mList = [100, 500, 1000, 2500, 5000, 10000, 15000, 20000, 25000, 30000];
          if (mList.includes(daysSince)) {
            tdDaysSince.style.color = "#0a7f3f";
            tdDaysSince.style.fontWeight = "bold";
          } else {
            for (let m of mList) {
              if (daysSince >= (m - 14) && daysSince < m) {
                tdDaysSince.style.color = "orange";
                tdDaysSince.style.fontWeight = "bold";
                break;
              }
            }
          }

          // --- 4. Apply Row Highlighting Logic ---
          if (daysToGo === 0) {
            tr.style.backgroundColor = "#c6efce"; // Light Green
            tr.style.color = "#006100";           // Dark Green Text
          } else if (daysToGo < 15) {
            tr.style.backgroundColor = "#ffeb9c"; // Light Orange/Yellow
            tr.style.color = "#9c6500";           // Dark Orange Text
          }

          // --- 5. Actions ---
          const tdActions = document.createElement("td");
          tdActions.className = "actions-cell";
          
          const viewLink = document.createElement("a");
          viewLink.href = `/events/${evt.id}`;
          viewLink.textContent = "View";
          viewLink.style.marginRight = "10px";
          tdActions.appendChild(viewLink);

          const editLink = document.createElement("a");
          editLink.href = `/events/${evt.id}/edit`;
          editLink.textContent = "Edit";
          tdActions.appendChild(editLink);

          // Append all cells
          tr.appendChild(tdName);
          tr.appendChild(tdBase);
          tr.appendChild(tdNext);
          tr.appendChild(tdTz);
          tr.appendChild(tdTime);
          tr.appendChild(tdDaysSince);
          tr.appendChild(tdDaysToGo);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });
      } catch (err) {
        statusEl.textContent = "Network error loading events.";
      }
    }

    async function apiRequest(path, options = {}) {
      const headers = options.headers || {};
      if (!headers["Content-Type"]) {
        headers["Content-Type"] = "application/json";
      }
      if (accessToken) {
        headers["Authorization"] = "Bearer " + accessToken;
      }
      const res = await fetch(path, { ...options, headers });
      const text = await res.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch {
        data = text;
      }
      if (!res.ok) {
        const detail = data && data.detail ? data.detail : res.statusText;
        throw new Error(detail);
      }
      return data;
    }

    async function loadTheme() {
      const picker = document.getElementById("theme-color-picker");
      if (!accessToken) {
        document.documentElement.style.setProperty("--page-bg", DEFAULT_THEME);
        if (picker) picker.value = DEFAULT_THEME;
        return;
      }
      try {
        const me = await apiRequest("/api/me");
        const theme = me.theme_color || DEFAULT_THEME;
        document.documentElement.style.setProperty("--page-bg", theme);
        if (picker) picker.value = theme;
      } catch (e) {
        document.documentElement.style.setProperty("--page-bg", DEFAULT_THEME);
        if (picker) picker.value = DEFAULT_THEME;
      }
    }

    async function saveTheme(colorOrNull) {
      if (!accessToken) return;
      const body = colorOrNull
        ? { theme_color: colorOrNull }
        : { theme_color: DEFAULT_THEME };
      try {
        await apiRequest("/api/me", {
          method: "PUT",
          body: JSON.stringify(body),
        });
      } catch (e) {
        alert("Failed to save theme color");
      }
    }


    document.getElementById("google-connect-btn").addEventListener("click", async () => {
      try {
        if (!googleConnected) {
          const me = await apiRequest("/api/me");
          window.location.href = "/google/login?user_id=" + me.id;
        } else {
          await apiRequest("/api/integrations/google/disconnect", { method: "POST" });
          googleConnected = false;
          fetchIntegrationsStatus();
        }
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById("btn-refresh-upcoming").addEventListener("click", loadUpcomingEvents);

    document.addEventListener("DOMContentLoaded", () => {
      const btnTheme = document.getElementById("btn-theme");
      const backdrop = document.getElementById("theme-modal-backdrop");
      const picker = document.getElementById("theme-color-picker");
      const btnThemeClose = document.getElementById("btn-theme-close");
      const btnThemeReset = document.getElementById("btn-theme-reset");

      loadTheme();

      if (btnTheme && backdrop) {
        btnTheme.addEventListener("click", () => {
          backdrop.style.display = "flex";
        });
      }

      if (btnThemeClose && backdrop) {
        btnThemeClose.addEventListener("click", () => {
          backdrop.style.display = "none";
        });
      }

      if (backdrop) {
        backdrop.addEventListener("click", (e) => {
          if (e.target === backdrop) {
            backdrop.style.display = "none";
          }
        });
      }

      if (picker) {
        picker.addEventListener("input", (e) => {
          const color = e.target.value;
          document.documentElement.style.setProperty("--page-bg", color);
          saveTheme(color);
        });
      }

      if (btnThemeReset && picker) {
        btnThemeReset.addEventListener("click", async () => {
          picker.value = DEFAULT_THEME;
          document.documentElement.style.setProperty("--page-bg", DEFAULT_THEME);
          await saveTheme(DEFAULT_THEME);
        });
      }

      fetchIntegrationsStatus();
      setupCreateForm();
      loadUpcomingEvents();
    });

  </script>
</body>
</html>