<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Milestone Reminders</title>
  <style>
    :root {
      --page-bg: #f5f5f5; /* default */
      --font-color: #111827;
    }

    html, body {
      height: 100%;
    }

    html {
      background: var(--page-bg);  /* theme color */
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 0;
      background: transparent;     /* was #f5f5f5; make it transparent */
      color: var(--font-color);
    }

    header {
      background: #333;
      color: white;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header .left {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    header .right {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    header a {
      color: #ffd700;
      text-decoration: none;
      font-weight: 500;
    }

    main {
      padding: 1rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    .integrations-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .integration-block {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    .status-label {
      font-weight: 600;
    }

    .status-text {
      font-weight: 600;
    }

    .status-connected {
      color: #0a7f3f;
    }

    .status-disconnected {
      color: #b00020;
    }

    .btn-link {
      padding: 0.35rem 0.7rem;
      border-radius: 4px;
      border: none;
      background: #333;
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
    }

    .panel {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    }

    .panel h2 {
      margin-top: 0;
    }

    .field-row {
      margin-bottom: 0.75rem;
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.95rem;
      gap: 0.25rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      max-width: 300px;
    }

    .checkbox-row {
      margin-bottom: 0.5rem;
    }

    .checkbox-row label {
      flex-direction: row;
      align-items: center;
      gap: 0.4rem;
    }

    button {
      padding: 0.45rem 0.9rem;
      border-radius: 4px;
      border: none;
      background: #333;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
    }

    button.secondary {
      background: #555;
      font-size: 0.85rem;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .pill-list {
      margin-top: 0.45rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: #eee;
      font-size: 0.85rem;
    }

    .pill button {
      background: transparent;
      border: none;
      color: #333;
      font-size: 0.8rem;
      padding: 0;
      margin: 0;
      cursor: pointer;
    }

    .inline-input {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.25rem;
      align-items: center;
    }

    .inline-input input[type="number"] {
      width: 90px;
    }

    .error {
      color: #b00020;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .success {
      color: #0a7f3f;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }

    .actions-cell a {
      margin-right: 0.4rem;
      text-decoration: none;
      color: #1a73e8;
    }

    .actions-cell button {
      background: #b00020;
      color: white;
      padding: 0.3rem 0.5rem;
      font-size: 0.85rem;
    }

    .settings-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .settings-bar label {
      flex-direction: row;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
    }

    .settings-bar input[type="color"] {
      padding: 0;
      border: none;
      width: 32px;
      height: 24px;
      background: transparent;
    }

    .theme-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .theme-modal {
      background: #ffffff;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
      max-width: 320px;
      width: 100%;
      font-size: 0.9rem;
    }

    .theme-modal h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
    }

    .theme-modal-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0 0.75rem 0;
    }

    .theme-modal-row input[type="color"] {
      padding: 0;
      border: none;
      width: 40px;
      height: 26px;
      background: transparent;
    }

    .theme-modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .theme-btn-text {
      background: transparent;
      border: none;
      color: #1f2937;
      padding: 0.35rem 0.7rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .theme-btn-primary {
      background: #333;
      color: #ffffff;
      border-radius: 4px;
      padding: 0.35rem 0.7rem;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }

    /* Settings popup */

    .settings-popup-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .settings-popup {
      background: #ffffff;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
      max-width: 360px;
      width: 100%;
      font-size: 0.9rem;
    }

    .settings-popup h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
    }

    .settings-row {
      margin-bottom: 0.75rem;
    }

    .settings-row label {
      font-size: 0.9rem;
      display: block;
      margin-bottom: 0.25rem;
    }

    .settings-inline {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }

    .settings-inline input[type="number"] {
      max-width: 120px;
    }

    .settings-popup-buttons {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-top: 0.5rem;
      align-items: center;
    }

    .settings-footer {
      margin-top: 1rem;
    }

    .settings-actions-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 0.75rem;
    }

    .settings-actions-row {
      display: inline-flex;
      gap: 0.75rem;
    }

    .settings-action-box {
      display: inline-flex;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }

    .settings-close-row {
      display: flex;
      justify-content: center;
    }

    .settings-tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.25rem;
    }

    .settings-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.8rem;
    }

    .settings-tag button {
      background: transparent;
      border: none;
      color: #374151;
      font-size: 0.75rem;
      padding: 0;
      margin: 0;
      cursor: pointer;
    }

    .settings-small {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 0.2rem;
    }

    #row-notifications {
      margin-top: 0.75rem;
    }

    .upcoming-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }

    .upcoming-legend {
      display: flex;
      gap: 2.75rem;
      margin-top: 0.75rem;
      font-size: 0.85rem;
      color: #4b5563;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .legend-box {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.1);
    }

    /* Match your row colors for today (green) and < 15 days (yellow) */
    .legend-today {
      background-color: #c6efce;
    }

    .legend-two-weeks {
      background-color: #ffeb9c;
    }

  </style>
</head>
<body>
  <header>
    <div class="left">
      <a href="/events/all">All Events</a>
    </div>
    <div class="right">
      <button type="button" id="btn-settings" class="btn-link">Settings</button>
    </div>
  </header>

  <main>
    <h1>Milestone reminders for people you care about</h1>
    <p style="margin: 0 0 0.75rem 0; color:#4b5563; max-width: 720px;">
      Use this page to store important dates for your friends and family so the app can automatically create reminders in your calendar and keep upcoming milestones in one place.
    </p>

    <div class="panel">
      <h2>Create Event</h2>
      <form id="create-event-form">
        <div class="field-row">
          <label><b>Type</b>
            <select id="eventtype">
              <option value="birthday">Birthday üéÇ</option>
              <option value="wedding">Wedding üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®üèª</option>
              <option value="engagement">Engagement üíç</option>
              <option value="other_individual">üë§ Other - Individual</option>
              <option value="other_couple">üë• Other - Couple</option>
            </select>
          </label>
        </div>

        <div class="field-row" id="row-title" style="display:none;">
          <label><b>Title</b>
            <input type="text" id="title">
          </label>
        </div>

        <div class="field-row">
          <label><b><span id="label-name1-text">Name</span></b>
            <input type="text" id="name1" required>
          </label>
        </div>

        <div class="field-row" id="row-couple-name2">
          <label><b>Name 2</b>
            <input type="text" id="name2">
          </label>
        </div>

        <div class="field-row">
          <label>
            <span><b>Base date</b> üìÖ</span>
            <input type="date" id="basedate" required>
          </label>
        </div>

        <div class="field-row">
          <label>
            <span><b>Timezone</b> üåç</span>
            <select id="timezone">
              {% for tz in TIMEZONES %}
                <option value="{{ tz }}">{{ tz }}</option>
              {% endfor %}
            </select>
          </label>
        </div>

        <div class="field-row">
          <label>
            <span><b>Event time</b> ‚è∞ (HH:MM)</span>
            <input type="text" id="sendtime" required value="00:00">
          </label>
        </div>

        <div class="checkbox-row" id="row-create-calendar">
          <label>
            <input type="checkbox" id="createcalendar">
            <span>Create Calendar Event</span>
          </label>
        </div>

        <div class="checkbox-row" id="row-milestones">
          <label>
            <input type="checkbox" id="createmilestones" checked>
            <span>Create milestone events</span>
          </label>
        </div>

        <div id="milestones-config" style="display:none; margin-top:0.5rem;">
          <label><b>Milestone days from base date</b></label>
          <div class="pill-list" id="milestone-pills"></div>
          <div class="inline-input">
            <input type="number" id="milestone-input" placeholder="e.g. 120">
            <button type="button" id="btn-add-milestone" class="secondary">Add</button>
          </div>
          <div class="settings-small">Only milestones after today will be created.</div>
        </div>

        <div class="checkbox-row" id="row-notifications">
          <label>
            <input type="checkbox" id="createnotifications">
            <span>Add notifications to calendar event</span>
          </label>
        </div>

        <div id="notifications-section" style="display:none;">
          <div class="field-row">
            <label><b>Notifications for this event</b>
              <div class="inline-input">
                <input type="number" id="event-notify-number" min="0" placeholder="e.g. 7">
                <select id="event-notify-unit">
                  <option value="minutes">Minutes</option>
                  <option value="hours">Hours</option>
                  <option value="days">Days</option>
                  <option value="weeks">Weeks</option>
                  <option value="months">Months</option>
                </select>
                <button type="button" id="event-notify-add" class="secondary">Add</button>
              </div>
              <div class="pill-list" id="event-notify-tags"></div>
              <div class="settings-small">Maximum 5 notifications per event.</div>
            </label>
          </div>
        </div>

        <button type="submit">Create</button>
      </form>
      <div id="create-status" class="error"></div>
      <div id="create-ok" class="success"></div>
    </div>

    <div class="panel">
      <h2>Upcoming Events (next 2 months)</h2>
      <button id="btn-refresh-upcoming">Refresh Upcoming</button>
      <div class="upcoming-legend">
        <span class="legend-item">
          <span class="legend-box legend-today"></span> Today
        </span>
        <span class="legend-item">
          <span class="legend-box legend-two-weeks"></span> Within next two weeks
        </span>
      </div>
      <table id="upcoming-table">
        <thead>
          <tr>
            <th>Name(s)</th>
            <th>Title</th>
            <th>Base Date</th>
            <th>Next Occurrence</th>
            <th>Timezone</th>
            <th>Send Time</th>
            <th>Days Since Base</th>
            <th>Days To Go</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="upcoming-body"></tbody>
      </table>
      <div id="upcoming-status" class="error"></div>
    </div>

    <div id="theme-modal-backdrop" class="theme-modal-backdrop">
      <div class="theme-modal">
        <h3>Theme background</h3>
        <div class="theme-modal-row">
          <input type="color" id="theme-color-picker">
          <span style="color:#4b5563;">Choose a color for the page background.</span>
        </div>
        <div class="theme-modal-buttons">
          <button type="button" id="btn-theme-reset" class="theme-btn-text">Reset to default</button>
          <button type="button" id="btn-theme-close" class="theme-btn-primary">Close</button>
        </div>
      </div>
    </div>

    <!-- Settings popup -->
    <div id="settings-popup-backdrop" class="settings-popup-backdrop">
      <div class="settings-popup">
        <h3>Settings</h3>

        <div class="integrations-bar">
          <div class="integration-block">
            <span class="status-label">Google Calendar:</span>
            <span id="google-status-text" class="status-text status-disconnected"></span>
            <button type="button" class="btn-link" id="google-connect-btn">
              Connect Google Calendar
            </button>
          </div>
        </div>

        <div class="settings-row">
          <label>Theme colour</label>
          <div class="settings-inline">
            <input type="color" id="settings-theme-color">
            <button type="button" id="settings-theme-apply" class="secondary">Apply</button>
          </div>
          <div class="settings-small">Updates the background theme colour.</div>
        </div>

        <div class="settings-row">
          <label>Font colour</label>
          <div class="settings-inline">
            <input type="color" id="settings-font-color">
            <button type="button" id="settings-font-apply" class="secondary">Apply</button>
          </div>
          <div class="settings-small">Changes font colour on this page.</div>
        </div>

        <div class="settings-row">
          <label>Default milestone days</label>
          <div class="settings-inline">
            <input type="number" id="settings-milestone-input" placeholder="e.g. 100">
            <button type="button" id="settings-milestone-add" class="secondary">Add</button>
          </div>
          <div class="settings-tag-list" id="settings-milestone-tags"></div>
          <div class="settings-small">Used as defaults when creating events.</div>
        </div>

        <div class="settings-row">
          <label>Default notifications</label>
          <div class="settings-inline">
            <input type="number" id="settings-notify-number" min="0" placeholder="e.g. 7">
            <select id="settings-notify-unit">
              <option value="minutes">Minutes</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
            </select>
            <button type="button" id="settings-notify-add" class="secondary">Add</button>
          </div>
          <div class="settings-tag-list" id="settings-notify-tags"></div>
          <div class="settings-small">Multiple notifications can be set for a single event.</div>
        </div>

        <div class="settings-footer">
          <div class="settings-actions-wrapper">
            <div class="settings-actions-row">
              <span class="settings-action-box">
                <button type="button" id="settings-reset" class="theme-btn-text">Reset to defaults</button>
              </span>
              <span class="settings-action-box">
                <button type="button" id="settings-change-password" class="theme-btn-text">Change Password</button>
              </span>
              <span class="settings-action-box">
                <button type="button" id="settings-logout" class="theme-btn-text">Logout</button>
              </span>
            </div>
          </div>
          <div class="settings-close-row">
            <button type="button" id="settings-close" class="theme-btn-primary">Close</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    
    const accessToken = localStorage.getItem("access_token") || "";
    const DEFAULT_THEME = "#f5f5f5";
    const DEFAULT_FONT = "#111827";
    const DEFAULT_MILESTONE_DAYS = [100, 500, 1000, 2500, 5000, 10000, 15000, 20000, 25000, 30000];

    let googleConnected = false;

    // settings defaults
    let defaultMilestoneDays = DEFAULT_MILESTONE_DAYS.slice();
    let settingsMilestoneDays = defaultMilestoneDays.slice();
    let defaultNotifications = [
      { value: 1, unit: "hours" },
      { value: 2, unit: "hours" },
      { value: 1, unit: "days" },
      { value: 1, unit: "weeks" },
      { value: 2, unit: "weeks" }
    ]; // list of { value, unit }

    async function fetchIntegrationsStatus() {
      const googleStatusText = document.getElementById("google-status-text");
      const createCalendarEl = document.getElementById("createcalendar");
      const googleConnectBtn = document.getElementById("google-connect-btn");

      if (!accessToken) {
        googleStatusText.textContent = "Not connected";
        googleStatusText.classList.remove("status-connected");
        googleStatusText.classList.add("status-disconnected");
        googleConnected = false;
        createCalendarEl.checked = false;
        googleConnectBtn.textContent = "Connect Google Calendar";
        return;
      }

      try {
        const resp = await fetch("/api/integrations/status", {
          headers: {
            Authorization: "Bearer " + accessToken,
          },
        });
        if (!resp.ok) throw new Error("status fetch failed");
        const data = await resp.json();

        googleConnected = !!data.google_connected;

        const createNotificationsEl = document.getElementById("createnotifications");
        const notifSection = document.getElementById("notifications-section");
        if (createNotificationsEl) {
          createNotificationsEl.checked = googleConnected;
        }
        if (notifSection) {
          notifSection.style.display = googleConnected ? "" : "none";
        }

        googleStatusText.textContent = googleConnected ? "Connected" : "Not connected";
        googleStatusText.classList.toggle("status-connected", googleConnected);
        googleStatusText.classList.toggle("status-disconnected", !googleConnected);

        createCalendarEl.checked = googleConnected;

        googleConnectBtn.textContent = googleConnected ? "Disconnect Google Calendar" : "Connect Google Calendar";
        googleConnectBtn.href = "/google_connect";
      } catch (e) {
        googleStatusText.textContent = "Error";
        googleStatusText.classList.remove("status-connected");
        googleStatusText.classList.add("status-disconnected");
        googleConnected = false;
        createCalendarEl.checked = false;
        googleConnectBtn.textContent = "Connect Google Calendar";
      }
    }

    function setupCreateForm() {
      const form = document.getElementById("create-event-form");
      const eventTypeEl = document.getElementById("eventtype");
      const titleRow = document.getElementById("row-title");
      const titleInput = document.getElementById("title");
      const labelName1Text = document.getElementById("label-name1-text");
      const rowCoupleName2 = document.getElementById("row-couple-name2");
      const createCalendarEl = document.getElementById("createcalendar");
      const createMilestonesEl = document.getElementById("createmilestones");
      const milestonesConfig = document.getElementById("milestones-config");
      const milestoneInput = document.getElementById("milestone-input");
      const milestonePills = document.getElementById("milestone-pills");
      const btnAddMilestone = document.getElementById("btn-add-milestone");
      const createStatus = document.getElementById("create-status");
      const createOk = document.getElementById("create-ok");

      const createNotificationsEl = document.getElementById("createnotifications");

      if (createNotificationsEl) {
        createNotificationsEl.addEventListener("change", () => {
          if (createNotificationsEl.checked && !googleConnected) {
            createNotificationsEl.checked = false;
            alert("Google Calendar is not connected. Please connect Google Calendar from Settings.");
          }
          // toggle visibility of notifications section
          const notifSection = document.getElementById("notifications-section");
          if (notifSection) {
            notifSection.style.display = createNotificationsEl.checked ? "" : "none";
          }
        });
      }

      const eventNotifyNumber = document.getElementById("event-notify-number");
      const eventNotifyUnit = document.getElementById("event-notify-unit");
      const eventNotifyAdd = document.getElementById("event-notify-add");
      const eventNotifyTags = document.getElementById("event-notify-tags");

      let milestoneDays = defaultMilestoneDays.slice();
      let eventNotifications = defaultNotifications.slice(); // start from Settings list

      function renderEventNotifyTags() {
        eventNotifyTags.innerHTML = "";

        const unitToMinutes = {
          minutes: 1,
          hours: 60,
          days: 60 * 24,
          weeks: 60 * 24 * 7,
          months: 60 * 24 * 30
        };

        const sorted = eventNotifications
          .map((n, index) => ({
            ...n,
            index,
            minutes: n.value * (unitToMinutes[n.unit] || 1)
          }))
          .sort((a, b) => a.minutes - b.minutes);

        sorted.forEach((nWrapped) => {
          const n = nWrapped;
          const tag = document.createElement("span");
          tag.className = "settings-tag";

          const labelUnit =
            n.value === 1 && n.unit.endsWith("s")
              ? n.unit.slice(0, -1)
              : n.unit;

          tag.textContent = `${n.value} ${labelUnit}`;

          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "√ó";
          btn.addEventListener("click", () => {
            eventNotifications = eventNotifications.filter((_, i) => i !== n.index);
            renderEventNotifyTags();
          });

          tag.appendChild(btn);
          eventNotifyTags.appendChild(tag);
        });
      }

      function renderMilestones() {
        milestonePills.innerHTML = "";
        milestoneDays.forEach((d) => {
          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = d + " days";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "√ó";
          btn.addEventListener("click", () => {
            milestoneDays = milestoneDays.filter((x) => x !== d);
            renderMilestones();
          });
          pill.appendChild(btn);
          milestonePills.appendChild(pill);
        });
      }

      milestoneInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const val = parseInt(milestoneInput.value, 10);
          if (!isNaN(val) && val > 0 && !milestoneDays.includes(val)) {
            milestoneDays.push(val);
            milestoneDays.sort((a, b) => a - b);
            renderMilestones();
            milestoneInput.value = "";
          }
        }
      });

      btnAddMilestone.addEventListener("click", () => {
        const val = parseInt(milestoneInput.value, 10);
        if (!isNaN(val) && val > 0 && !milestoneDays.includes(val)) {
          milestoneDays.push(val);
          milestoneDays.sort((a, b) => a - b);
          renderMilestones();
          milestoneInput.value = "";
        }
      });

      function updateTypeDependentFields() {
        const type = eventTypeEl.value;

        if (type === "other_individual" || type === "other_couple") {
          titleRow.style.display = "";
        } else {
          titleRow.style.display = "none";
          titleInput.value = "";
        }

        if (type === "wedding" || type === "engagement" || type === "other_couple") {
          labelName1Text.textContent = "Name 1";
          rowCoupleName2.style.display = "";
        } else {
          labelName1Text.textContent = "Name";
          rowCoupleName2.style.display = "none";
          document.getElementById("name2").value = "";
        }
      }

      eventTypeEl.addEventListener("change", updateTypeDependentFields);

      createCalendarEl.addEventListener("change", () => {
        if (createCalendarEl.checked && !googleConnected) {
          createCalendarEl.checked = false;
          alert("Google Calendar is not connected. Please connect Google Calendar first on the \"Connect Google Calendar\" page.");
        }
      });

      createMilestonesEl.addEventListener("change", () => {
        milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";
      });

      if (eventNotifyAdd && eventNotifyNumber && eventNotifyUnit) {
        eventNotifyAdd.addEventListener("click", () => {
          const val = parseInt(eventNotifyNumber.value, 10);
          const unit = eventNotifyUnit.value;
          if (!isNaN(val) && val >= 0) {
            if (eventNotifications.length >= 5) {
              alert("You can only have up to 5 notifications per event.");
              return;
            }
            const exists = eventNotifications.some((n) => n.value === val && n.unit === unit);
            if (!exists) {
              eventNotifications.push({ value: val, unit });
              renderEventNotifyTags();
            }
            eventNotifyNumber.value = "";
            eventNotifyUnit.value = "days";
          }
        });

        eventNotifyNumber.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const val = parseInt(eventNotifyNumber.value, 10);
            const unit = eventNotifyUnit.value;
            if (!isNaN(val) && val >= 0) {
              if (eventNotifications.length >= 5) {
                alert("You can only have up to 5 notifications per event.");
                return;
              }
              const exists = eventNotifications.some((n) => n.value === val && n.unit === unit);
              if (!exists) {
                eventNotifications.push({ value: val, unit });
                renderEventNotifyTags();
              }
              eventNotifyNumber.value = "";
              eventNotifyUnit.value = "days";
            }
          }
        });
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        createStatus.textContent = "";
        createOk.textContent = "";

        if (!accessToken) {
          createStatus.textContent = "You must be logged in.";
          return;
        }

        const event_type = eventTypeEl.value;
        const name1 = document.getElementById("name1").value.trim();
        const name2 = document.getElementById("name2").value.trim();
        const base_date = document.getElementById("basedate").value;
        const timezone = document.getElementById("timezone").value;
        const send_time = document.getElementById("sendtime").value.trim();
        const create_calendar = createCalendarEl.checked;
        const create_milestones = createMilestonesEl.checked;
        const use_notifications = createNotificationsEl ? createNotificationsEl.checked : false;
        const title = titleInput.value.trim();

        const payload = {
          event_type,
          name1,
          name2: name2 || null,
          base_date,
          timezone,
          send_time,
          create_calendar,
          create_milestones,
          milestone_days: milestoneDays,
          title: title || null,
          notifications: use_notifications ? eventNotifications : [],
        };

        try {
          const resp = await fetch("/api/events", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + accessToken,
            },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          if (!resp.ok) {
            const msg = data.detail || "Error creating event.";
            createStatus.textContent = msg;
            alert(msg);
          } else {
            createOk.textContent = "Event created.";
            form.reset();
            milestoneDays = defaultMilestoneDays.slice();
            renderMilestones();
            document.getElementById("eventtype").value = "birthday";
            document.getElementById("createcalendar").checked = googleConnected;
            document.getElementById("createmilestones").checked = true;
            if (createNotificationsEl) {
              createNotificationsEl.checked = googleConnected;
            }
            updateTypeDependentFields();
            milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";
            eventNotifications = defaultNotifications.slice();
            renderEventNotifyTags();  
            loadUpcomingEvents();
          }
        } catch (err) {
          createStatus.textContent = "Network error creating event.";
        }
      });

      milestonesConfig.style.display = createMilestonesEl.checked ? "" : "none";
      renderMilestones();
      updateTypeDependentFields();
      renderEventNotifyTags();
    }

    async function loadUpcomingEvents() {
      const tbody = document.getElementById("upcoming-body");
      const statusEl = document.getElementById("upcoming-status");
      tbody.innerHTML = "";
      statusEl.textContent = "";

      if (!accessToken) {
        statusEl.textContent = "You must be logged in.";
        return;
      }

      try {
        const resp = await fetch("/api/events/upcoming", {
          headers: {
            Authorization: "Bearer " + accessToken,
          },
        });
        const data = await resp.json();
        if (!resp.ok) {
          statusEl.textContent = data.detail || "Error loading events.";
          return;
        }

        if (!Array.isArray(data) || data.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 9;
          td.textContent = "No upcoming events.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const sorted = data.slice().sort((a, b) => {
          const dA = a.next_occurrence || a.base_date;
          const dB = b.next_occurrence || b.base_date;
          if (dA < dB) return -1;
          if (dA > dB) return 1;
          const tA = a.send_time || "00:00";
          const tB = b.send_time || "00:00";
          return tA.localeCompare(tB);
        });

        sorted.forEach((evt) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          const names = evt.name2 ? `${evt.name1} & ${evt.name2}` : evt.name1;
          tdName.textContent = names;

          const tdTitle = document.createElement('td');
          tdTitle.textContent =
            (evt.title || '').trim() &&
            (evt.event_type === 'other_individual' || evt.event_type === 'other_couple')
              ? (evt.title || '').trim()
              : (evt.event_type || '').replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());

          const tdBase = document.createElement("td");

          // If this is a milestone, reconstruct original base date
          if (evt.milestone_offset_days && evt.milestone_offset_days > 0 && evt.next_occurrence) {
              const nextDate = new Date(evt.next_occurrence + "T00:00:00");
              nextDate.setDate(nextDate.getDate() - evt.milestone_offset_days);

              const year  = nextDate.getFullYear();
              const month = String(nextDate.getMonth() + 1).padStart(2, "0");
              const day   = String(nextDate.getDate()).padStart(2, "0");
              tdBase.textContent = `${year}-${month}-${day}`;
          } else {
              tdBase.textContent = evt.base_date;
          }

          const tdNext = document.createElement("td");
          tdNext.textContent = evt.next_occurrence;

          const tdTz = document.createElement("td");
          tdTz.textContent = evt.timezone;

          const tdTime = document.createElement("td");
          tdTime.textContent = evt.send_time;

          // --- Days Since Base & Days To Go Calculation ---
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // 1. Days To Go
          const nextOccurDate = new Date(evt.next_occurrence + "T00:00:00");
          nextOccurDate.setHours(0, 0, 0, 0);
          const daysToGo = Math.ceil((nextOccurDate - today) / (1000 * 60 * 60 * 24));

          const tdDaysToGo = document.createElement("td");
          tdDaysToGo.textContent = daysToGo === 0 ? "Today" : daysToGo;

          // 2. Days Since Base
          const tdDaysSince = document.createElement("td");
          const baseDate = new Date(evt.base_date + "T00:00:00");
          baseDate.setHours(0, 0, 0, 0);
          let daysSince = Math.floor((today - baseDate) / (1000 * 60 * 60 * 24));

          if (evt.milestone_offset_days && evt.milestone_offset_days > 0) {
              daysSince = evt.milestone_offset_days - daysToGo;
          }
          tdDaysSince.textContent = daysSince;

          // --- COLORING LOGIC 1: Text color for milestones ---
          const mList = [100, 500, 1000, 2500, 5000, 10000, 15000, 20000, 25000, 30000];
          if (mList.includes(daysSince)) {
            tdDaysSince.style.color = "#0a7f3f";
            tdDaysSince.style.fontWeight = "bold";
          } else {
            for (let m of mList) {
              if (daysSince >= (m - 14) && daysSince < m) {
                tdDaysSince.style.color = "orange";
                tdDaysSince.style.fontWeight = "bold";
                break;
              }
            }
          }

          // --- COLORING LOGIC 2: Row background based on proximity ---
          if (daysToGo === 0) {
            tr.style.backgroundColor = "#c6efce"; // Light Green
            tr.style.color = "#006100";           // Dark Green Text
          } else if (daysToGo > 0 && daysToGo < 15) {
            tr.style.backgroundColor = "#ffeb9c"; // Light Orange/Yellow
            tr.style.color = "#9c6500";           // Dark Orange Text
          }

          const tdActions = document.createElement("td");
          tdActions.className = "actions-cell";
          const viewLink = document.createElement("a");
          viewLink.href = `/events/${evt.id}`;
          viewLink.textContent = "View";
          viewLink.style.marginRight = "10px";
          tdActions.appendChild(viewLink);

          const editLink = document.createElement("a");
          editLink.href = `/events/${evt.id}/edit`;
          editLink.textContent = "Edit";
          tdActions.appendChild(editLink);

          tr.appendChild(tdName);
          tr.appendChild(tdTitle);
          tr.appendChild(tdBase);
          tr.appendChild(tdNext);
          tr.appendChild(tdTz);
          tr.appendChild(tdTime);
          tr.appendChild(tdDaysSince);
          tr.appendChild(tdDaysToGo);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });
      } catch (err) {
        statusEl.textContent = "Network error loading events.";
      }
    }

    async function apiRequest(path, options = {}) {
      const headers = options.headers || {};
      if (!headers["Content-Type"]) {
        headers["Content-Type"] = "application/json";
      }
      if (accessToken) {
        headers["Authorization"] = "Bearer " + accessToken;
      }
      const res = await fetch(path, { ...options, headers });
      const text = await res.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch {
        data = text;
      }
      if (!res.ok) {
        const detail = data && data.detail ? data.detail : res.statusText;
        throw new Error(detail);
      }
      return data;
    }

    async function loadTheme() {
      const picker = document.getElementById("theme-color-picker");
      if (!accessToken) {
        document.documentElement.style.setProperty("--page-bg", DEFAULT_THEME);
        document.documentElement.style.setProperty("--font-color", DEFAULT_FONT);
        if (picker) picker.value = DEFAULT_THEME;
        return;
      }
      try {
        const me = await apiRequest("/api/me");
        const theme = me.theme_color || DEFAULT_THEME;
        const font = me.font_color || DEFAULT_FONT;
        document.documentElement.style.setProperty("--page-bg", theme);
        applyFontColor(font);
        if (picker) picker.value = theme;
      } catch (e) {
        document.documentElement.style.setProperty("--page-bg", DEFAULT_THEME);
        applyFontColor(DEFAULT_FONT);
        if (picker) picker.value = DEFAULT_THEME;
      }
    }

    async function saveTheme(colorOrNull) {
      if (!accessToken) return;
      const currentFont = getComputedStyle(document.documentElement).getPropertyValue("--font-color").trim() || DEFAULT_FONT;
      const body = {
        theme_color: colorOrNull || DEFAULT_THEME,
        font_color: currentFont
      };
      try {
        await apiRequest("/api/me", {
          method: "PUT",
          body: JSON.stringify(body),
        });
      } catch (e) {
        alert("Failed to save theme color");
      }
    }

    function applyFontColor(color) {
      document.documentElement.style.setProperty("--font-color", color);
      document.body.style.color = color;
    }

    function initSettingsPopup() {
      const backdrop = document.getElementById("settings-popup-backdrop");
      const btnSettings = document.getElementById("btn-settings");
      const googleStatusEl = document.getElementById("settings-google-status");
      const googleBtn = document.getElementById("settings-google-btn");
      const themeColorInput = document.getElementById("settings-theme-color");
      const themeApplyBtn = document.getElementById("settings-theme-apply");
      const fontColorInput = document.getElementById("settings-font-color");
      const fontApplyBtn = document.getElementById("settings-font-apply");
      if (themeColorInput) {
        themeColorInput.addEventListener("change", () => {
          const color = themeColorInput.value || DEFAULT_THEME;
          document.documentElement.style.setProperty("--page-bg", color);
          saveTheme(color);
        });
      }

      if (fontColorInput) {
        fontColorInput.addEventListener("change", () => {
          const color = fontColorInput.value || DEFAULT_FONT;
          applyFontColor(color);
          // preserve background theme when saving
          const currentTheme =
            getComputedStyle(document.documentElement)
              .getPropertyValue("--page-bg")
              .trim() || DEFAULT_THEME;
          saveTheme(currentTheme);
        });
      }
      const msInput = document.getElementById("settings-milestone-input");
      const msAddBtn = document.getElementById("settings-milestone-add");
      const msTags = document.getElementById("settings-milestone-tags");
      const notifyNumber = document.getElementById("settings-notify-number");
      const notifyUnit = document.getElementById("settings-notify-unit");
      const notifyAddBtn = document.getElementById("settings-notify-add");
      const notifyTags = document.getElementById("settings-notify-tags");
      const btnClose = document.getElementById("settings-close");
      const btnReset = document.getElementById("settings-reset");
      const btnChangePassword = document.getElementById("settings-change-password");
      const btnLogout = document.getElementById("settings-logout");

      if (btnChangePassword) {
        btnChangePassword.addEventListener("click", () => {
          window.location.href = "/change-password";
        });
      }

      if (btnLogout) {
        btnLogout.addEventListener("click", () => {
          // clear token if you want to fully log out on client
          localStorage.removeItem("access_token");
          localStorage.removeItem("accesstoken");
          window.location.href = "/login";
        });
      }

      function renderSettingsMilestones() {
        msTags.innerHTML = "";
        settingsMilestoneDays.slice().sort((a, b) => a - b).forEach((d) => {
          const tag = document.createElement("span");
          tag.className = "settings-tag";
          tag.textContent = d + "d";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "√ó";
          btn.addEventListener("click", () => {
            settingsMilestoneDays = settingsMilestoneDays.filter((x) => x !== d);
            defaultMilestoneDays = settingsMilestoneDays.slice();
            renderSettingsMilestones();
          });
          tag.appendChild(btn);
          msTags.appendChild(tag);
        });
      }

      function renderNotifyTags() {
        notifyTags.innerHTML = "";

        // sort by actual time offset (minutes)
        const unitToMinutes = {
          minutes: 1,
          hours: 60,
          days: 60 * 24,
          weeks: 60 * 24 * 7,
          months: 60 * 24 * 30
        };

        const sorted = defaultNotifications
          .map((n, index) => ({
            ...n,
            index,
            minutes: n.value * (unitToMinutes[n.unit] || 1)
          }))
          .sort((a, b) => a.minutes - b.minutes);

        sorted.forEach((nWrapped) => {
          const n = nWrapped;
          const tag = document.createElement("span");
          tag.className = "settings-tag";

          const labelUnit =
            n.value === 1 && n.unit.endsWith("s")
              ? n.unit.slice(0, -1)
              : n.unit;

          tag.textContent = `${n.value} ${labelUnit}`;

          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "√ó";
          btn.addEventListener("click", () => {
            defaultNotifications = defaultNotifications.filter((_, i) => i !== n.index);
            renderNotifyTags();
          });

          tag.appendChild(btn);
          notifyTags.appendChild(tag);
        });
      }

      function openPopup() {
        if (!backdrop) return;
        backdrop.style.display = "flex";
        googleStatusEl.textContent = googleConnected ? "Currently connected" : "Currently disconnected";

        const currentTheme = getComputedStyle(document.documentElement).getPropertyValue("--page-bg").trim() || DEFAULT_THEME;
        themeColorInput.value = currentTheme && currentTheme.startsWith("#") ? currentTheme : DEFAULT_THEME;

        const currentFont = getComputedStyle(document.documentElement).getPropertyValue("--font-color").trim() || DEFAULT_FONT;
        if (currentFont.startsWith("#")) {
          fontColorInput.value = currentFont;
        } else {
          fontColorInput.value = DEFAULT_FONT;
        }

        renderSettingsMilestones();
        renderNotifyTags();
        notifyNumber.value = "";
        notifyUnit.value = "days";
      }

      function closePopup() {
        if (backdrop) {
          backdrop.style.display = "none";
        }
      }

      if (btnSettings && backdrop) {
        btnSettings.addEventListener("click", () => {
          openPopup();
        });
      }

      if (backdrop) {
        backdrop.addEventListener("click", (e) => {
          if (e.target === backdrop) {
            closePopup();
          }
        });
      }

      if (btnClose) {
        btnClose.addEventListener("click", () => {
          closePopup();
        });
      }

      if (googleBtn) {
        googleBtn.addEventListener("click", async () => {
          if (!accessToken) {
            alert("You must be logged in.");
            return;
          }
          try {
            if (!googleConnected) {
              const me = await apiRequest("/api/me");
              window.location.href = "/google/login?user_id=" + me.id;
            } else {
              await apiRequest("/api/integrations/google/disconnect", { method: "POST" });
              googleConnected = false;
              googleStatusEl.textContent = "Currently disconnected";
              fetchIntegrationsStatus();
            }
          } catch (err) {
            alert(err.message);
          }
        });
      }

      if (themeApplyBtn && themeColorInput) {
        themeApplyBtn.addEventListener("click", () => {
          const color = themeColorInput.value || DEFAULT_THEME;
          document.documentElement.style.setProperty("--page-bg", color);
          saveTheme(color);
        });
      }

      if (fontApplyBtn && fontColorInput) {
        fontApplyBtn.addEventListener("click", () => {
          const color = fontColorInput.value || DEFAULT_FONT;
          applyFontColor(color);
          saveTheme(getComputedStyle(document.documentElement).getPropertyValue("--page-bg").trim() || DEFAULT_THEME);
        });
      }

      if (msAddBtn && msInput) {
        msAddBtn.addEventListener("click", () => {
          const val = parseInt(msInput.value, 10);
          if (!isNaN(val) && val > 0 && !settingsMilestoneDays.includes(val)) {
            settingsMilestoneDays.push(val);
            defaultMilestoneDays = settingsMilestoneDays.slice();
            renderSettingsMilestones();
            msInput.value = "";
          }
        });

        msInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const val = parseInt(msInput.value, 10);
            if (!isNaN(val) && val > 0 && !settingsMilestoneDays.includes(val)) {
              settingsMilestoneDays.push(val);
              defaultMilestoneDays = settingsMilestoneDays.slice();
              renderSettingsMilestones();
              msInput.value = "";
            }
          }
        });
      }

      if (notifyAddBtn && notifyNumber && notifyUnit) {
        notifyAddBtn.addEventListener("click", () => {
          const val = parseInt(notifyNumber.value, 10);
          const unit = notifyUnit.value;
          if (!isNaN(val) && val >= 0) {
            const exists = defaultNotifications.some((n) => n.value === val && n.unit === unit);
            if (!exists) {
              defaultNotifications.push({ value: val, unit });
              renderNotifyTags();
            }
            notifyNumber.value = "";
            notifyUnit.value = "days";
          }
        });

        notifyNumber.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const val = parseInt(notifyNumber.value, 10);
            const unit = notifyUnit.value;
            if (!isNaN(val) && val >= 0) {
              const exists = defaultNotifications.some((n) => n.value === val && n.unit === unit);
              if (!exists) {
                defaultNotifications.push({ value: val, unit });
                renderNotifyTags();
              }
              notifyNumber.value = "";
              notifyUnit.value = "days";
            }
          }
        });
      }

      if (btnReset) {
        btnReset.addEventListener("click", async () => {
          // reset theme and font
          document.documentElement.style.setProperty("--page-bg", DEFAULT_THEME);
          applyFontColor(DEFAULT_FONT);
          await saveTheme(DEFAULT_THEME);

          // also reset the pickers shown in the settings popup
          if (themeColorInput) themeColorInput.value = DEFAULT_THEME;
          if (fontColorInput) fontColorInput.value = DEFAULT_FONT;

          // reset milestones
          defaultMilestoneDays = DEFAULT_MILESTONE_DAYS.slice();
          settingsMilestoneDays = defaultMilestoneDays.slice();
          renderSettingsMilestones();

          // reset notifications list
          defaultNotifications = [
            { value: 1, unit: "hours" },
            { value: 2, unit: "hours" },
            { value: 1, unit: "days" },
            { value: 1, unit: "weeks" },
            { value: 2, unit: "weeks" }
          ];
          renderNotifyTags();
        });
      }
    }

    document.getElementById("google-connect-btn").addEventListener("click", async () => {
      try {
        if (!googleConnected) {
          const me = await apiRequest("/api/me");
          window.location.href = "/google/login?user_id=" + me.id;
        } else {
          await apiRequest("/api/integrations/google/disconnect", { method: "POST" });
          googleConnected = false;
          fetchIntegrationsStatus();
        }
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById("btn-refresh-upcoming").addEventListener("click", loadUpcomingEvents);

    document.addEventListener("DOMContentLoaded", () => {
      const btnTheme = document.getElementById("btn-theme");
      const backdrop = document.getElementById("theme-modal-backdrop");
      const picker = document.getElementById("theme-color-picker");
      const btnThemeClose = document.getElementById("btn-theme-close");
      const btnThemeReset = document.getElementById("btn-theme-reset");

      loadTheme();

      if (btnTheme && backdrop) {
        btnTheme.addEventListener("click", () => {
          backdrop.style.display = "flex";
        });
      }

      if (btnThemeClose && backdrop) {
        btnThemeClose.addEventListener("click", () => {
          backdrop.style.display = "none";
        });
      }

      if (backdrop) {
        backdrop.addEventListener("click", (e) => {
          if (e.target === backdrop) {
            backdrop.style.display = "none";
          }
        });
      }

      if (picker) {
        picker.addEventListener("input", (e) => {
          const color = e.target.value;
          document.documentElement.style.setProperty("--page-bg", color);
          saveTheme(color);
        });
      }

      if (btnThemeReset && picker) {
        btnThemeReset.addEventListener("click", async () => {
          picker.value = DEFAULT_THEME;
          document.documentElement.style.setProperty("--page-bg", DEFAULT_THEME);
          await saveTheme(DEFAULT_THEME);
        });
      }

      fetchIntegrationsStatus();
      setupCreateForm();
      loadUpcomingEvents();
      initSettingsPopup();
    });

  </script>
</body>
</html>