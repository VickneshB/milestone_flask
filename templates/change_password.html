<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Change Password â€“ Milestone Events</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 20px; }
      h1 { margin-bottom: 0.5rem; }
      label { display:block; margin-top:0.5rem; }
      input { padding:4px 6px; width:100%; max-width:320px; }
      button { margin-top:0.5rem; padding:6px 10px; cursor:pointer; }
      .error { color:#b00; margin-top:0.5rem; }
      .success { color:#080; margin-top:0.5rem; }
      a { color:#06c; }
    </style>
  </head>
  <body>
    <h1>Change Password</h1>
    <p><a href="/events">&larr; Back to events</a></p>

    <label>Current password
      <input type="password" id="cp-current">
    </label>
    <label>New password
      <input type="password" id="cp-new">
    </label>
    <button id="btn-change-password">Change Password</button>
    <div id="cp-status" class="error"></div>
    <div id="cp-ok" class="success"></div>

    <script>
      let accessToken = null;

      function ensureLoggedIn() {
        const token = localStorage.getItem("access_token");
        if (!token) {
          window.location.href = "/login";
          return;
        }
        accessToken = token;
      }

      async function apiRequest(path, options = {}) {
        const headers = options.headers || {};
        headers["Content-Type"] = headers["Content-Type"] || "application/json";
        if (accessToken) {
          headers["Authorization"] = "Bearer " + accessToken;
        }
        const res = await fetch(path, { ...options, headers });
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (e) { data = text; }
        if (!res.ok) {
          const detail = data && data.detail ? data.detail : res.statusText;
          throw new Error(detail);
        }
        return data;
      }

      function setCpStatus(msg, ok=false) {
        const errDiv = document.getElementById("cp-status");
        const okDiv = document.getElementById("cp-ok");
        if (ok) {
          errDiv.textContent = "";
          okDiv.textContent = msg;
        } else {
          okDiv.textContent = "";
          errDiv.textContent = msg || "";
        }
      }

      document.getElementById("btn-change-password").addEventListener("click", async () => {
        const current_password = document.getElementById("cp-current").value;
        const new_password = document.getElementById("cp-new").value;
        setCpStatus("");
        try {
          await apiRequest("/auth/change-password", {
            method: "POST",
            body: JSON.stringify({ current_password, new_password })
          });
          setCpStatus("Password updated.", true);
          document.getElementById("cp-current").value = "";
          document.getElementById("cp-new").value = "";
        } catch (err) {
          setCpStatus(err.message);
        }
      });

      ensureLoggedIn();
    </script>
  </body>
</html>
